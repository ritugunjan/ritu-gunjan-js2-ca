<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>

<body>
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">

    </script>
    <div class="container">
        <div class="profile-page tx-13">
            <div class="row">
                <div class="col-12 grid-margin">
                    <div class="profile-header">
                        <div class="cover">

                            <div class="cover-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h1 class="profile-name p-4">Social site</h1>
                                </div>
                                <div class="d-none d-md-block">

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="row profile-body">

                <div class="d-none d-md-block col-md-4 col-xl-3 left-wrapper">

                </div>


                <div class="col-md-8 col-xl-6 middle-wrapper">
                    <div class="row">

                        <div class="col-md-12">
                            <div class="d-none" id="post_loader"
                                style="margin: 0 auto;display: flex;align-items: center;justify-content: center;padding: 2rem;">
                                <div class="spinner-border" role="status">
                                    <span class="sr-only">Loading...</span>
                                </div>
                            </div>
                            <div id="post_container">

                            </div>
                        </div>
                    </div>
                </div>


                <div class="d-none d-xl-block col-xl-3 right-wrapper">
                    <div class="row">
                        <div class="col-md-12 grid-margin">
                        </div>
                    </div>

                </div>
            </div>
        </div>
</body>
<script src="/api/request.js"></script>
<script src="/js/main.js"></script>

<script>


    let GlobalPost = [];
    const method = "POST";
    let timer = null

    function getQueryParams()
    {
        var queryParams = {};
        var searchParams = new URLSearchParams(window.location.search);

        for (var pair of searchParams.entries())
        {
            var key = decodeURIComponent(pair[0]);
            var value = decodeURIComponent(pair[1] || "");
            queryParams[key] = value;
        }

        return queryParams;
    }
    async function getPostData(token)
    {
        let { post_id } = getQueryParams()
        const endpoint = `posts/${post_id}`;
        const method = "GET";
        const options = {
            method,
            headers: {
                "Content-type": "application/json; charset=UTF-8",
                Authorization: `Bearer ${JSON.parse(token)}`,
            },
        };
        document.getElementById("post_loader").classList.remove("d-none")
        await fetch(`${BASE_URL}${endpoint}?_author=true&_reactions=true&_comments=true'`, options)
            .then((response) => response.json())
            .then((data) =>
            {
                const { title, body, tags } = data;
                GlobalPost = data
                console.log({ GlobalPost })
                renderPost(GlobalPost)
            });

        document.getElementById("post_loader").classList.add("d-none")
    }
    let token = window.localStorage.getItem("accessToken");


    getPostData(token)

    function renderPost(postArray)
    {


        let container = document.getElementById("post_container");
        container.innerHTML = "";

        container.innerHTML = postHtmlElement(postArray)
    }

    function formatTimeElapsed(dateString)
    {
        var now = new Date();
        var date = new Date(dateString);

        var timeElapsed = Math.floor((now - date) / 1000); // Time elapsed in seconds

        if (timeElapsed < 60)
        {
            return timeElapsed + " second" + (timeElapsed === 1 ? "" : "s") + " ago";
        } else if (timeElapsed < 3600)
        {
            var minutes = Math.floor(timeElapsed / 60);
            return minutes + " minute" + (minutes === 1 ? "" : "s") + " ago";
        } else if (timeElapsed < 86400)
        {
            var hours = Math.floor(timeElapsed / 3600);
            return hours + " hour" + (hours === 1 ? "" : "s") + " ago";
        } else
        {
            var days = Math.floor(timeElapsed / 86400);
            var formattedDate = date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear();
            return days + " days ago";
        }
    }

    function getAvatarOrInitial(avatar, name)
    {
        if (avatar)
        {
            return ` <img class="img-xs rounded-circle" src="${avatar}" alt>`;
        } else if (name)
        {
            return name.charAt(0).toUpperCase();
        } else
        {
            return "";
        }
    }

    function postHtmlElement(data)
    {
        let { body, created, id, media, tags, title, updated, _count, author } = data
        let { name, avatar } = author
        let { comments, reactions } = _count;
        let postElement = ` <div class="card rounded">
                                <div class="card-header">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center">
                                            <div class="user_avatar_initial" >
                                                ${getAvatarOrInitial(avatar, name)}
                                               
                                            </div>
                                            <div class="ml-2">
                                                <a href="/viewpost/?post_id=${id}">
                                                <p>${name}</p>
                                                </a>
                                                <p class="tx-11 text-muted">${formatTimeElapsed(updated)}</p>
                                            </div>
                                        </div>
                                        <div class='d-flex'>
                                            <a class="dropdown-item d-flex align-items-center" href="/updatepost/?post_id=${id}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                                stroke-linecap="round" stroke-linejoin="round"
                                                class="feather feather-edit-2 icon-sm mr-2">
                                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z">
                                                </path>
                                            </svg></a>
                                        <div class="dropdown">
                                            
                                            <button class="btn p-0" type="button" id="dropdownMenuButton3"
                                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                    viewbox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                    class="feather feather-more-horizontal icon-lg pb-3px">
                                                    <circle cx="12" cy="12" r="1"></circle>
                                                    <circle cx="19" cy="12" r="1"></circle>
                                                    <circle cx="5" cy="12" r="1"></circle>
                                                </svg>
                                            </button>
                                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton3">
                                                <a class="dropdown-item d-flex align-items-center" href="/deletepost/?post_id=${id}">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                                        viewbox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                                        class="feather feather-meh icon-sm mr-2">
                                                        <circle cx="12" cy="12" r="10"></circle>
                                                        <line x1="8" y1="15" x2="16" y2="15"></line>
                                                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                                    </svg> 
                                                    <span class>Delete</span>
                                                </a>
                                              </div>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="mb-3 tx-14">${body}</p>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex post-actions">
                                        <a href="javascript:;" class="d-flex align-items-center text-muted mr-4">
                                            <p>${reactions}</p>
                                            <p class="d-none d-md-block ml-2">Like</p>
                                        </a>
                                        <a href="javascript:;" class="d-flex align-items-center text-muted mr-4">
                                            <p>${comments}</p>
                                            <p class="d-none d-md-block ml-2">Comment</p>
                                        </a>
                                      
                                    </div>
                                </div>
                            </div>`

        return postElement

    }




</script>

</html>